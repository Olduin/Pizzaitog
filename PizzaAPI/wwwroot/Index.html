<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/site.css" asp-append-version="true" />

</head>
<body>
    <div class="text-center">
        <h1 class="display-4">Welcome</h1>
        <p>Learn about <a href="https://docs.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
    </div>

    <div class="Page-container"></div>
    <div class="my-flex-container"></div>

    <!-- Модальное окно Bootstrap -->
    <div class="modal fade" id="pizzaModal" tabindex="-1" aria-labelledby="pizzaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-4 shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="pizzaModalLabel">Добавить пиццу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <form id="pizza-form">
                    <div class="modal-body">
                        <input type="hidden" id="pizza-id">
                        <div class="mb-3">
                            <label for="pizza-name" class="form-label">Название</label>
                            <input type="text" class="form-control" id="pizza-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="pizza-image" class="form-label">Изображение (URL)</label>
                            <input type="text" class="form-control" id="pizza-image">
                        </div>
                        <div class="mb-3">
                            <label for="pizza-ingredients" class="form-label">Ингредиенты</label>
                            <input type="text" class="form-control" id="pizza-ingredients">
                        </div>
                        <div class="mb-3">
                            <label for="pizza-price" class="form-label">Цена</label>
                            <input type="number" class="form-control" id="pizza-price" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="pizza-weight" class="form-label">Вес (грамм)</label>
                            <input type="number" class="form-control" id="pizza-weight">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-success">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="overlay" style="display:none; position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);"></div>

</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    const uri = "/api/pizza/";
    function generatePizzaCards(pizzas) {
        const container = $(".Page-container");
        const containerFlex = $(".my-flex-container");
        const AddButtonHtml = `<a class="button-link-Create">Добавить пиццу</a>`;
        container.empty();

        pizzas.forEach(pizza => {
            const cardHtml = `
                <div class="flex-card">
                    <img class="card-img" data-id="${pizza.id}" src="${pizza.image}">
                    <a class="card-name" href="Details/${pizza.id}" >${pizza.name}</a>
                    <div class="card-ingredients">${pizza.ingredients}</div>
                    <div class="card-footer">
                        <div class="card-price">${pizza.price} &#8381;</div>
                        <div class="card-weight">${pizza.weight} гр.</div>
                        <a href="#" class="button-link">В корзину</a>
                        <a data-id="${pizza.id}" class="button-link-Edit">Изменить</a>
                        <a data-id="${pizza.id}" class="button-link-Delete">Удалить</a>
                    </div>
                </div>
            `;
            containerFlex.append(cardHtml);

        });
        container.append(AddButtonHtml);
        container.append(containerFlex);

        $('.card-img').on('click', function () {
            var pizzaId = ($(this).data('id'));
            $.ajax({
                url: uri + pizzaId,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    generatePizzaDetail(data);

                },
                error: function () {
                    console.error("Ошибка при получении одной пиццы");
                }
            })
        });

        $('.button-link-Create').on('click', function () {
            openModal();
        });

        $('.button-link-Edit').on('click', function () {
            const pizzaId = $(this).data('id');
            $.ajax({
                url: uri + pizzaId,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    openModal(data);
                },
                error: function () {
                    alert("Ошибка при загрузке пиццы");
                }
            });
        });



        //$('.button-link-Delete').on('click', function () {
        //    deletePizza();
        //})

        $('.button-link-Delete').on('click', function (e) {
            var pizzaId = $(this).data('id');
            let IsDelete = confirm("Удалить элемент?");
            if (IsDelete == true) {
                $.ajax({
                    url: uri + pizzaId,
                    type: "DELETE",
                    data: { id: pizzaId },
                    success: function (data) {
                        window.location.reload();
                    },

                })
            }
        })

        //$('.button-link-Edit').on('click', function (e) {
        //    var pizzaId = $(this).data('id');
        //    EditPizza(id);

        //    if (IsDelete == true) {
        //        $.ajax({
        //            url: uri + pizzaId,
        //            type: "PUT",
        //            data: { id: pizzaId },
        //            success: function (data) {
        //                window.location.reload();
        //            },
        //        })
        //    }
        //})

        $('.button-link-Edit').on('click', function () {
            var pizzaId = $(this).data('id');
            $.ajax({
                url: uri + pizzaId,
                type: "PUT",
                dataType: "json",
                success: function (data) {
                    generatePizzaEdit(data);
                },
                error: function () {
                    console.error("Ошибка при получении одной пиццы");
                }
            })
        });
    };


    function generatePizzaDetail(pizza) {
        const container = $(".Page-container");
        container.empty();

        const cardHtml = `
            <div class="pizza-details-card">
            <button id="back-to-list" class="btn btn-outline-primary">
    &#8592; Назад
</button>
                <img class="card-img" src="${pizza.image}">
                <h4 class="pizza-title">${pizza.name}</h4>
                <div class="pizza-ingredient"> ${pizza.ingredients} </div>
                <div class="card-footer">
                    <div class="card-price">${pizza.price} &#8381;</div>
                    <div class="card-weight">${pizza.weight} гр.</div>
                    <a href="#" class="button-link">В корзину</a>
                </div>
            </div>
        `;

        container.append(cardHtml);

        $('#back-to-list').on('click', function () {
            $.ajax({
                url: "/api/pizza",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    generatePizzaCards(data);
                },
                error: function () {
                    console.error("Ошибка при получении списка пицц");
                }
            });
        });
    };


    $('#pizza-form').on('submit', function (e) {
        e.preventDefault();

        const pizza = {
            name: $('#pizza-name').val(),
            image: $('#pizza-image').val(),
            ingredients: $('#pizza-ingredients').val(),
            price: parseFloat($('#pizza-price').val()),
            weight: parseFloat($('#pizza-weight').val())
        };

        const id = $('#pizza-id').val();

        if (id) {
            // редактирование
            $.ajax({
                url: uri + id,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify({ id, ...pizza }),
                success: function () {
                    closeModal();
                    location.reload();
                },
                error: () => alert("Ошибка при обновлении пиццы")
            });
        } else {
            // создание
            $.ajax({
                url: uri,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(pizza),
                success: function () {
                    closeModal();
                    location.reload();
                },
                error: () => alert("Ошибка при создании пиццы")
            });
        }
    });


    const pizzaModal = new bootstrap.Modal(document.getElementById('pizzaModal'));

    function openModal(pizza = null) {
        if (pizza) {
            $('#pizzaModalLabel').text("Редактировать пиццу");
            $('#pizza-id').val(pizza.id);
            $('#pizza-name').val(pizza.name);
            $('#pizza-image').val(pizza.image);
            $('#pizza-ingredients').val(pizza.ingredients);
            $('#pizza-price').val(pizza.price);
            $('#pizza-weight').val(pizza.weight);
        } else {
            $('#pizzaModalLabel').text("Добавить пиццу");
            $('#pizza-form')[0].reset();
            $('#pizza-id').val('');
        }
        pizzaModal.show();
    }

    function closeModal() {
        pizzaModal.hide();
    }
    



    $.ajax({
        url: "/api/pizza",
        type: "GET",
        dataType: "json",
        success: function (data) {
            generatePizzaCards(data);
        },
        error: function () {
            console.error("Ошибка при получении списка пицц");
        }
    });

</script>
